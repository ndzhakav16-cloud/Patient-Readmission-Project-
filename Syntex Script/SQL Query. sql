COMPREHENSIVE HOSPITAL READMISSION ANALYSIS FINAL PROCESSED DATASET
-- ========================================================================

WITH Hospital_Readmission_Analysis AS (
    SELECT 
        -- Patient
        patient_id,
        age,
        gender,
        admission_type,
        length_of_stay,
        number_of_diagnoses,
        blood_pressure,
        blood_sugar_levels,
        previous_admissions,
        readmission,
        
       

        -- Risk Profile Bucketing
        CASE 
            WHEN admission_type = 'Emergency' 
                 AND number_of_diagnoses >= 7 
                 AND previous_admissions >= 3 THEN 'High Risk'
            WHEN (admission_type = 'Emergency' AND number_of_diagnoses >= 4)
                 OR (number_of_diagnoses >= 7 AND previous_admissions >= 2)
                 OR (admission_type = 'Emergency' AND previous_admissions >= 3) THEN 'Medium Risk'
            WHEN admission_type = 'Elective' 
                 AND number_of_diagnoses <= 3 
                 AND previous_admissions <= 1 THEN 'Low Risk'
            ELSE 'Standard Risk'
        END as risk_profile,

        -- Risk Score Calculation (0-6 points)
        
        (CASE WHEN admission_type = 'Emergency' THEN 2 ELSE 0 END) +
        (CASE WHEN number_of_diagnoses >= 7 THEN 2 
              WHEN number_of_diagnoses >= 4 THEN 1 
              ELSE 0 END) +
        (CASE WHEN previous_admissions >= 3 THEN 2 
              WHEN previous_admissions >= 1 THEN 1 
              ELSE 0 END) as risk_score,
        
        
        
        -- Detailed Risk Category
        CASE 
            WHEN risk_score >= 5 THEN 'Very High Risk'
            WHEN risk_score >= 4 THEN 'High Risk'
            WHEN risk_score >= 2 THEN 'Medium Risk'
            ELSE 'Low Risk'
        END as risk_category,
        
        -- Patient Segments
        CASE 
            WHEN age BETWEEN 18 AND 30 AND admission_type = 'Emergency' THEN 'Young Emergency Patients'
            WHEN number_of_diagnoses >= 7 AND previous_admissions >= 3 THEN 'Complex Chronic Patients'
            WHEN admission_type = 'Emergency' AND length_of_stay > 14 THEN 'Long-stay Emergency Patients'
            WHEN admission_type = 'Elective' AND number_of_diagnoses <= 3 AND previous_admissions <= 1 THEN 'Low Risk Elective'
            ELSE 'General Population'
        END as patient_segment,
        
        -- Age Groups
        CASE 
            WHEN age BETWEEN 18 AND 30 THEN 'Youth'
            WHEN age BETWEEN 31 AND 50 THEN 'Young Aldult'
            WHEN age BETWEEN 51 AND 70 THEN 'Aldult'
            ELSE 'Elder Patient'
        END as age_group,
        
        -- Diagnosis Categories
        CASE 
            WHEN number_of_diagnoses <= 3 THEN '1-3 Diagnoses'
            WHEN number_of_diagnoses <= 6 THEN '4-6 Diagnoses'
            ELSE '7-9 Diagnoses'
        END as diagnosis_category,
        
        -- Previous Admissions Categories
        CASE 
            WHEN previous_admissions <= 0 THEN ' First Entry'
            WHEN previous_admissions <= 1 THEN ' Previous'
            WHEN previous_admissions <= 2 THEN ' Previous'
            
            ELSE ' Previous' 
        END as previous_admissions_category,
        
        -- Length of Stay Categories
        CASE 
            WHEN length_of_stay <= 7 THEN 'Short Stay (1-7 days)'
            WHEN length_of_stay <= 14 THEN 'Medium Stay (8-14 days)'
            ELSE 'Long Stay (15+ days)'
        END as stay_category,
        
        -- Blood Pressure Categories
        CASE 
            WHEN blood_pressure < 90 THEN 'Low (<90)'
            WHEN blood_pressure <= 120 THEN 'Normal (90-120)'
            WHEN blood_pressure <= 140 THEN 'High (121-140)'
            ELSE 'Very High (>140)'
        END as bp_category,
        
        -- Blood Sugar Categories
        CASE 
            WHEN blood_sugar_levels < 70 THEN 'Low (<70)'
            WHEN blood_sugar_levels <= 100 THEN 'Normal (70-100)'
            WHEN blood_sugar_levels <= 125 THEN 'Borderline (101-125)'
            ELSE 'High (>125)'
        END as bs_category,
        
        -- Individual Risk Flags
        CASE WHEN admission_type = 'Emergency' THEN 1 ELSE 0 END as is_emergency,
        CASE WHEN number_of_diagnoses >= 7 THEN 1 ELSE 0 END as has_high_diagnoses,
        CASE WHEN previous_admissions >= 3 THEN 1 ELSE 0 END as has_frequent_admissions,
        CASE WHEN readmission = 'Yes' THEN 1 ELSE 0 END as is_readmitted
        
    FROM HOSPITAL.PATIENT.READMISSION
    )


-- =============================================
-- FINAL PROCESSED DATASET
-- =============================================
SELECT 
    *,
    -- Additional calculated fields
    CASE 
        WHEN risk_category IN ('Very High Risk', 'High Risk') AND is_readmitted = 1 
        THEN 'High Risk - Readmitted'
        WHEN risk_category IN ('Very High Risk', 'High Risk') AND is_readmitted = 0 
        THEN 'High Risk - Not Readmitted'
        WHEN risk_category = 'Medium Risk' AND is_readmitted = 1 
        THEN 'Medium Risk - Readmitted'
        WHEN risk_category = 'Medium Risk' AND is_readmitted = 0 
        THEN 'Medium Risk - Not Readmitted'
        WHEN risk_category = 'Low Risk' AND is_readmitted = 1 
        THEN 'Low Risk - Readmitted'
        ELSE 'Low Risk - Not Readmitted'
    END as risk_readmission_status,
    
    -- Intervention Priority
    CASE 
        WHEN risk_score >= 5 THEN 'Priority 1 - Immediate Intervention'
        WHEN risk_score >= 4 THEN 'Priority 2 - High Intervention'
        WHEN risk_score >= 2 THEN 'Priority 3 - Moderate Intervention'
        ELSE 'Priority 4 - Routine Care'
    END as intervention_priority
    
FROM Hospital_Readmission_Analysis
ORDER BY risk_score DESC, is_readmitted DESC, numb
